import streamlit as st
import random 

# ----------------------------------------------------------------------------------
# 1. Base de Conhecimento e Fun√ß√µes (O C√âREBRO)
# ----------------------------------------------------------------------------------

# Dicion√°rio de G√™neros e Caracter√≠sticas (Base de Conhecimento do App)
GENEROS = {
    "Artigo de Opini√£o": {
        "caracteristicas": [
            "Apresenta uma Tese clara.",
            "Uso de Argumentos e contra-argumentos.",
            "Linguagem subjetiva (1¬™ pessoa)."
        ],
        "literal": ["Qual a principal tese defendida pelo autor?"],
        "inferencial": ["A qual grupo social o autor parece se dirigir ao usar o termo 'n√≥s'?"],
        "critico": ["O posicionamento do autor √© atual ou datado? Justifique, considerando o contexto social do RJ."],
        
        "feedback_literal": "Acertou! Voc√™ identificou a informa√ß√£o no texto, que √© o primeiro passo para a leitura.",
        "feedback_inferencial": "√ìtima conex√£o! Voc√™ conseguiu deduzir o sentido impl√≠cito. Prossiga para o senso cr√≠tico.",
        "feedback_critico": "Excelente argumento! Seu posicionamento est√° embasado e considera o contexto do g√™nero. Continue a construir seu repert√≥rio.",
        
        "ajuda_literal": "Revise o primeiro par√°grafo. A resposta √© expl√≠cita.",
        "ajuda_inferencial": "Leia as entrelinhas. Qual a inten√ß√£o do autor ao usar essa palavra? Tente conectar duas ideias diferentes.",
        "ajuda_critico": "Lembre-se das caracter√≠sticas do Artigo de Opini√£o: sua resposta deve ter uma TESE. Qual √© a sua tese sobre o assunto?",
    },
    
    "Conto": {
        "caracteristicas": [
            "Narrativa curta com poucos personagens.",
            "Possui cl√≠max e desfecho r√°pidos.",
            "Foco em um √∫nico evento central."
        ],
        "literal": ["Quem s√£o os personagens principais e onde a hist√≥ria se passa?"],
        "inferencial": ["Qual a principal emo√ß√£o ou estado de esp√≠rito do protagonista? Qual trecho sugere isso?"],
        "critico": ["O Conto reflete algum aspecto da realidade social? Qual e por qu√™?"],
        
        "feedback_literal": "Acerto! Localiza√ß√£o de fatos dominada.",
        "feedback_inferencial": "Conseguiu ler as entrelinhas da not√≠cia.",
        "feedback_critico": "Avalia√ß√£o √©tica e social do fato noticiado foi fundamentada.",
        
        "ajuda_literal": "Busque o Lide: Onde, quem, o qu√™.",
        "ajuda_inferencial": "O que a not√≠cia implica, mas n√£o diz abertamente?",
        "ajuda_critico": "Pense no vi√©s. O texto √© neutro ou favorece uma parte?",
    },
    
    # Este bloco foi inclu√≠do para evitar erros de sintaxe no restante do seu c√≥digo.
    # Ele ser√° usado como um backup caso os outros dois g√™neros n√£o sejam suficientes no futuro.
    "Not√≠cia": {
        "caracteristicas": [
            "Linguagem objetiva e formal.",
            "Estrutura em Lide (o qu√™, quem, quando, onde, por qu√™).",
            "Foco nos fatos, sem opini√£o expl√≠cita."
        ],
        "literal": ["Qual foi o principal fato noticiado e quem s√£o os envolvidos?"],
        "inferencial": ["Qual a poss√≠vel causa n√£o declarada para a omiss√£o de um nome na not√≠cia?"],
        "critico": ["O ve√≠culo de comunica√ß√£o demonstrou parcialidade? Justifique."],
        
        "feedback_literal": "Acerto! Localiza√ß√£o de fatos dominada.",
        "feedback_inferencial": "Conseguiu ler as entrelinhas da not√≠cia.",
        "feedback_critico": "Avalia√ß√£o √©tica e social do fato noticiado foi bem fundamentada.",
        
        "ajuda_literal": "Busque o Lide: Onde, quem, o qu√™.",
        "ajuda_inferencial": "O que a not√≠cia implica, mas n√£o diz abertamente?",
        "ajuda_critico": "Pense no vi√©s. O texto √© neutro ou favorece uma parte?",
    }
}

# Fun√ß√µes auxiliares (Corrigidas e simplificadas)
def simular_avaliacao_e_feedback(nivel: str, genero_escolhido: str, resposta_aluno_esta_correta: bool):
    """ Simula a avalia√ß√£o de uma resposta e gera o feedback construtivo. """
    dados_genero = GENEROS.get(genero_escolhido)

    if dados_genero:
        st.subheader(f"--- FEEDBACK N√çVEL {nivel.upper()} ---")

        # Os campos no dicion√°rio s√£o 'feedback_literal' e 'ajuda_literal' (e suas varia√ß√µes)
        feedback_key = f'feedback_{nivel}'
        ajuda_key = f'ajuda_{nivel}'
        
        if resposta_aluno_esta_correta and feedback_key in dados_genero:
            st.success(f"‚úÖ Acerto! {dados_genero[feedback_key]}")
        elif not resposta_aluno_esta_correta and ajuda_key in dados_genero:
            st.error(f"‚ùå Aten√ß√£o! Sua resposta precisa de refinamento.")
            st.info(f"üí° Dica: {dados_genero[ajuda_key]}")
        else:
            st.warning("Feedback n√£o dispon√≠vel para este n√≠vel/g√™nero.")


def analisar_texto_e_gerar_roteiro(texto: str, genero_escolhido: str):
    """ Gera o roteiro de leitura guiada no Streamlit. """
    
    genero_data = GENEROS.get(genero_escolhido)

    if not genero_data:
        st.error("G√™nero textual n√£o encontrado na base de dados.")
        return

    st.markdown(f"#### G√™nero Detectado: **{genero_escolhido.upper()}**")
    st.write("Caracter√≠sticas Essenciais para Leitura:")
    for carac in genero_data["caracteristicas"]:
        st.markdown(f"- **{carac}**")

    st.markdown("---")
    st.subheader("ROTEIRO DE LEITURA GUIADA")

    # Lista das chaves de n√≠veis de leitura
    niveis_leitura = ['literal', 'inferencial', 'critico']

    for i, nivel in enumerate(niveis_leitura):
        if nivel in genero_data and genero_data[nivel]:
            st.markdown(f"##### {i+1}. N√çVEL {nivel.upper()} ({nivel.capitalize()})")
            
            # Pega a primeira pergunta do n√≠vel (como os valores s√£o listas, usa [0])
            pergunta = genero_data[nivel][0]
            st.markdown(f"**Pergunta:** {pergunta}")
            
            # SIMULA√á√ÉO: O aluno acertou o literal e o cr√≠tico, mas errou o inferencial
            simular_acerto = (nivel != 'inferencial')
            simular_avaliacao_e_feedback(nivel, genero_escolhido, simular_acerto)


# ----------------------------------------------------------------------------------
# 2. INTERFACE STREAMLIT (O FRONT-END)
# ----------------------------------------------------------------------------------

st.set_page_config(page_title="Mentor de G√™neros Textuais", layout="wide")

st.title("üìö Mentor de G√™neros Textuais")
st.markdown("##### Ferramenta de apoio para professores de L√≠ngua Portuguesa e Reda√ß√£o.")

# Sele√ß√£o do G√™nero
generos_disponiveis = list(GENEROS.keys())
genero_selecionado = st.selectbox(
    "1. Selecione o G√™nero Textual para a an√°lise:",
    options=generos_disponiveis
)

# √Årea de Texto para Colar o Conte√∫do
texto_colado = st.text_area(
    "2. Cole o Texto a ser analisado aqui:",
    height=300,
    placeholder="Cole seu Artigo de Opini√£o, Not√≠cia ou outro G√™nero aqui..."
)

# Bot√£o de A√ß√£o
if st.button("üöÄ GERAR ROTEIRO DE LEITURA"):
    if texto_colado and genero_selecionado:
        # Chama a fun√ß√£o principal corrigida
        analisar_texto_e_gerar_roteiro(texto_colado, genero_selecionado)
    else:
        st.warning("Por favor, cole um texto e selecione um g√™nero para come√ßar.")
